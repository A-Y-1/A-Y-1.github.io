<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>NEONç¼–ç¨‹ | æ©™çš„Blog</title><meta name="author" content="æ©™"><meta name="copyright" content="æ©™"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="åŸä¹¦ä¸ºArmçš„NEON Programmerâ€™s Guideå’ŒNEON Programmer Guide for Armv8-Aã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="NEONç¼–ç¨‹">
<meta property="og:url" content="https://a-y-1.github.io/2024/01/02/Neon/index.html">
<meta property="og:site_name" content="æ©™çš„Blog">
<meta property="og:description" content="åŸä¹¦ä¸ºArmçš„NEON Programmerâ€™s Guideå’ŒNEON Programmer Guide for Armv8-Aã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://a-y-1.github.io/cover/NEON.png">
<meta property="article:published_time" content="2024-01-02T12:19:29.000Z">
<meta property="article:modified_time" content="2024-01-05T07:54:32.205Z">
<meta property="article:author" content="æ©™">
<meta property="article:tag" content="é«˜æ€§èƒ½è®¡ç®—">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://a-y-1.github.io/cover/NEON.png"><link rel="shortcut icon" href="/img/orange.png"><link rel="canonical" href="https://a-y-1.github.io/2024/01/02/Neon/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'NEONç¼–ç¨‹',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-01-05 15:54:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/a0.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../cover/0105.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="æ©™çš„Blog"><span class="site-name">æ©™çš„Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">NEONç¼–ç¨‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2024-01-02T12:19:29.000Z" title="å‘è¡¨äº 2024-01-02 20:19:29">2024-01-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-01-05T07:54:32.205Z" title="æ›´æ–°äº 2024-01-05 15:54:32">2024-01-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/">é«˜æ€§èƒ½è®¡ç®—</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="NEONç¼–ç¨‹"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p> åŸä¹¦ä¸ºArmçš„NEON Programmerâ€™s Guideå’ŒNEON Programmer Guide for Armv8-Aã€‚</p>
<span id="more"></span>
<h2 id="Chapter-1-Introduction"><a href="#Chapter-1-Introduction" class="headerlink" title="Chapter 1 Introduction"></a>Chapter 1 Introduction</h2><h3 id="1-1-Data-processing-technologies"><a href="#1-1-Data-processing-technologies" class="headerlink" title="1.1 Data processing technologies"></a>1.1 Data processing technologies</h3><p>æ•°æ®å¤„ç†çš„å¸¸è§æ–¹æ³•æœ‰SISDï¼ŒSIMD(vector mode)ï¼ŒSIMD(packed data mode)ã€‚</p>
<p><strong>vector mode</strong></p>
<p>å‡è®¾vector sizeä¸º4ï¼ŒSIMD(vector)å¯ä½¿ç”¨å•æŒ‡ä»¤å®Œæˆ4ä¸ªæ•°æ®çš„æ“ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VADD.F32 S24, S8, S16</span><br><span class="line">// four operations occur</span><br><span class="line">// S24 = S8 +S16</span><br><span class="line">// S25 = S9 +S17</span><br><span class="line">// S26 = S10 +S18</span><br><span class="line">// S27 = S11 +S20</span><br></pre></td></tr></table></figure>
<p>åœ¨ARMä¸­ï¼Œè¿™ç§°ä¸º<strong>Vector Floating Point(VFP)</strong>ï¼Œåœ¨ARMv5å¼•å…¥ï¼Œæºå’Œç›®æ ‡å¯„å­˜å™¨æ—¢å¯ä»¥æ˜¯å•ä¸ªå¯„å­˜å™¨ä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªå¯„å­˜å™¨ã€‚åœ¨ARMv7ï¼ŒNEONä»£æ›¿äº†VFPå®ç°å¤šå¯„å­˜å™¨ä¸Šçš„æ“ä½œã€‚</p>
<p><strong>packed data mode</strong></p>
<p>è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªæŒ‡ä»¤å¯ä»¥æŒ‡å®šä¸€ä¸ªå¤§å¯„å­˜å™¨ä¸­çš„å¤šä¸ªæ•°æ®éƒ¨åˆ†è¿›è¡Œç›¸åŒçš„å¤„ç†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VADD.I16 Q10, Q8, Q9</span><br><span class="line">// One operation adds two 64-bit registers,</span><br><span class="line">// but each of the four 16-bit lanes in the register is added separately.</span><br><span class="line">// There are no carries between the lanes</span><br></pre></td></tr></table></figure>
<p>åœ¨ARMä¸­ï¼Œè¿™ç§°ä¸ºSIMDæˆ–NEONã€‚</p>
<h3 id="1-2-Comparison-between-ARM-NEON-technology-and-other-implementations"><a href="#1-2-Comparison-between-ARM-NEON-technology-and-other-implementations" class="headerlink" title="1.2 Comparison between ARM NEON technology and other implementations"></a>1.2 Comparison between ARM NEON technology and other implementations</h3><p>ä¸ARMv6ä¸­ç›¸æ¯”ï¼ŒARM NEONçš„è®¡ç®—å•å…ƒæ”¯æŒ128-bitçš„å‘é‡æ“ä½œï¼Œåœ¨ARMv6ä¸­åªæœ‰32-bitçš„å‘é‡æ“ä½œã€‚å¹¶ä¸”åœ¨NEONä¸­ï¼Œè¿™äº›å¯„å­˜å™¨æ˜¯å•ç‹¬çš„ï¼Œå¹¶ä¸”å…¶å‘é‡æ“ä½œæ˜¯ä¸“é—¨ä¼˜åŒ–è¿‡çš„ï¼Œè€ŒARMv6ä¸­åªæ˜¯ä½¿ç”¨å’Œå…¶ä»–æŒ‡ä»¤ç›¸åŒçš„å¯„å­˜å™¨å’Œæµæ°´çº¿ã€‚</p>
<p>ä¸X86çš„MMX/SSEçš„æ¯”è¾ƒä»¥åŠä¸DSPçš„æ¯”è¾ƒè¿™é‡Œç•¥å»äº†ã€‚</p>
<h3 id="1-3-Architecture-support-for-NEON-technology"><a href="#1-3-Architecture-support-for-NEON-technology" class="headerlink" title="1.3 Architecture support for NEON technology"></a>1.3 Architecture support for NEON technology</h3><ul>
<li>ä¸èƒ½ä¿è¯ARMv7-Aæˆ–ARMv7-Rå¤„ç†å™¨åŒ…å«NEONæˆ–VFPæŠ€æœ¯ã€‚</li>
<li>ARMv7æ ¸å¿ƒçš„å¯èƒ½ç»„åˆåŒ…æ‹¬æ²¡æœ‰NEONæˆ–VFPå•å…ƒï¼Œä»…æœ‰NEONå•å…ƒï¼Œä»…æœ‰VFPå•å…ƒæˆ–åŒæ—¶å…·æœ‰NEONå’ŒVFPå•å…ƒã€‚</li>
<li>å…·æœ‰NEONå•å…ƒä½†æ²¡æœ‰VFPå•å…ƒçš„å¤„ç†å™¨æ— æ³•åœ¨ç¡¬ä»¶ä¸­æ‰§è¡Œæµ®ç‚¹è¿ç®—ã€‚</li>
<li>ç”±äºNEON SIMDæ“ä½œæ›´æœ‰æ•ˆåœ°æ‰§è¡ŒçŸ¢é‡è®¡ç®—ï¼Œä»ARMv7å¼•å…¥å¼€å§‹ï¼ŒVFPçŸ¢é‡æ¨¡å¼æ“ä½œè¢«å¼ƒç”¨ã€‚</li>
<li>VFPå•å…ƒæœ‰æ—¶è¢«ç§°ä¸ºæµ®ç‚¹å•å…ƒï¼ˆFPUï¼‰ã€‚</li>
<li>å…·æœ‰NEONæˆ–VFPå•å…ƒçš„å¤„ç†å™¨å¯èƒ½ä¸æ”¯æŒæŸäº›æ‰©å±•ï¼Œå¦‚åŠç²¾åº¦å’Œèåˆä¹˜åŠ ã€‚</li>
</ul>
<ul>
<li>åŠç²¾åº¦æŒ‡ä»¤ä»…åœ¨åŒ…å«åŠç²¾åº¦æ‰©å±•çš„NEONå’ŒVFPç³»ç»Ÿä¸Šå¯ç”¨ã€‚</li>
<li>Fused Multiply-Add (FMA)æŒ‡ä»¤æ˜¯å¯¹VFPå’ŒNEONçš„å¯é€‰æ‰©å±•ã€‚ä»…åœ¨å®ç°äº†Fused Multiply-Addæ‰©å±•çš„NEONæˆ–VFPç³»ç»Ÿä¸Šæ‰å¯ç”¨ã€‚VFPv4å’ŒAdvanced SIMDv2æ”¯æŒFused Multiply-AddæŒ‡ä»¤ã€‚</li>
</ul>
<h3 id="1-4-Fundamentals-of-NEON-technology"><a href="#1-4-Fundamentals-of-NEON-technology" class="headerlink" title="1.4 Fundamentals of NEON technology"></a>1.4 Fundamentals of NEON technology</h3><p>NEONå•å…ƒçš„ç»„æˆéƒ¨åˆ†åŒ…æ‹¬ï¼š</p>
<ul>
<li>NEONå¯„å­˜å™¨æ–‡ä»¶</li>
<li>NEONæ•´æ•°æ‰§è¡Œæµæ°´çº¿</li>
<li>NEONå•ç²¾åº¦æµ®ç‚¹æ‰§è¡Œæµæ°´çº¿</li>
<li>NEONåŠ è½½/å­˜å‚¨å’Œç½®æ¢æµæ°´çº¿ã€‚</li>
</ul>
<p>NEONæŒ‡ä»¤å’Œæµ®ç‚¹æŒ‡ä»¤ä½¿ç”¨ç›¸åŒçš„å¯„å­˜å™¨æ–‡ä»¶ï¼Œç§°ä¸ºNEONå’Œæµ®ç‚¹å¯„å­˜å™¨æ–‡ä»¶ã€‚è¿™ä¸ARMæ ¸å¿ƒå¯„å­˜å™¨æ–‡ä»¶ä¸åŒã€‚NEONå’Œæµ®ç‚¹å¯„å­˜å™¨æ–‡ä»¶æ˜¯ä¸€ç»„å¯è¢«è®¿é—®ä¸º32ä½ã€64ä½æˆ–128ä½å¯„å­˜å™¨çš„å¯„å­˜å™¨çš„é›†åˆã€‚å“ªä¸ªå¯„å­˜å™¨å¯ç”¨äºæŒ‡ä»¤å–å†³äºå®ƒæ˜¯NEONæŒ‡ä»¤è¿˜æ˜¯VFPæŒ‡ä»¤ã€‚æœ¬æ–‡å°†NEONå’Œæµ®ç‚¹å¯„å­˜å™¨ç§°ä¸ºNEONå¯„å­˜å™¨ã€‚æŸäº›VFPå’ŒNEONæŒ‡ä»¤åœ¨é€šç”¨å¯„å­˜å™¨å’ŒNEONå¯„å­˜å™¨ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œæˆ–ä½¿ç”¨ARMé€šç”¨å¯„å­˜å™¨æ¥å¯»å€å†…å­˜ã€‚</p>
<p><img src="/2024/01/02/Neon/image-20240102210351577.png" alt="image-20240102210351577" style="zoom: 33%;"></p>
<p><img src="/2024/01/02/Neon/image-20240102210425127.png" alt="image-20240102210425127" style="zoom:33%;"></p>
<p>Arm v8 AArch64æœ‰32ä¸ª128ä½å¯„å­˜å™¨ï¼Œä¹Ÿèƒ½å½“ä½œ32ä½Snå¯„å­˜å™¨æˆ–æ˜¯64ä½Dnå¯„å­˜å™¨ä½¿ç”¨ã€‚</p>
<p>ä¸€äº›NEONæŒ‡ä»¤ä¼šä½¿ç”¨æ ‡é‡ï¼Œæ ‡é‡å¯ä»¥é€šè¿‡ä¸‹æ ‡è¡¨ç¤ºã€‚ä¾‹å¦‚VMOV.8 D0[3], R3ã€‚NEONæ ‡é‡å¯ä»¥æ˜¯8bitï¼Œ16bitï¼Œ32bitæˆ–64bitï¼Œé™¤äº†ä¹˜æ³•æŒ‡ä»¤ï¼Œå…¶ä»–æŒ‡ä»¤éƒ½å¯ä»¥è®¿é—®å¯„å­˜å™¨ä¸­çš„ä»»æ„ä½æ ‡é‡ï¼Œä¹˜æ³•åªèƒ½è®¿é—®ï¼š</p>
<ul>
<li>16bitæ ‡é‡ï¼šD0-D7çš„[0-3]</li>
<li>32bitæ ‡é‡ï¼šD0-D15çš„[0-1]</li>
</ul>
<p>NEONä¸­çš„æ•°æ®ç±»å‹ï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240102211912523.png" alt="image-20240102211912523" style="zoom: 50%;"></p>
<h2 id="Chapter-2-Compiling-NEON-Instructions"><a href="#Chapter-2-Compiling-NEON-Instructions" class="headerlink" title="Chapter 2 Compiling NEON Instructions"></a>Chapter 2 Compiling NEON Instructions</h2><p>è¦ä½¿ç”¨GCCè¿›è¡Œè‡ªåŠ¨å‘é‡åŒ–ï¼Œéœ€è¦æ·»åŠ ä»¥ä¸‹é€‰é¡¹ï¼š</p>
<ul>
<li>-ftree-vectorize</li>
<li>-mfpu=neon</li>
<li>-mcpu æŒ‡å®šæ ¸æˆ–æ¶æ„</li>
</ul>
<p>ä»¥-O3ç¼–è¯‘ç›¸å½“äºæ·»åŠ äº†-ftree-vectorizeã€‚</p>
<p>é€šå¸¸ï¼Œå¦‚æœä¸é‡‡ç”¨è‡ªåŠ¨å‘é‡åŒ–ï¼Œä¸€èˆ¬ä½¿ç”¨INTRINSICä»£ç åµŒå…¥Cä¸­æ¥ä½¿ç”¨NEONã€‚éœ€è¦åœ¨å¤´æ–‡ä»¶ä¸­åŒ…å«<code>arm_neon.h</code>ï¼Œå¹¶æŒ‡å®šå¤„ç†å™¨ç±»å‹ï¼Œä¾‹å¦‚<code>-mcpu=cortex-a72</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arm_neon.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_float_arrays</span><span class="params">(<span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">float</span> *c, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// assume n is a multiple of 4</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i += <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="comment">// load 4 floats from a and b into NEON registers</span></span><br><span class="line">    <span class="type">float32x4_t</span> va = <span class="built_in">vld1q_f32</span>(a + i);</span><br><span class="line">    <span class="type">float32x4_t</span> vb = <span class="built_in">vld1q_f32</span>(b + i);</span><br><span class="line">    <span class="comment">// add the vectors</span></span><br><span class="line">    <span class="type">float32x4_t</span> vc = <span class="built_in">vaddq_f32</span>(va, vb);</span><br><span class="line">    <span class="comment">// store the result into c</span></span><br><span class="line">    <span class="built_in">vst1q_f32</span>(c + i, vc);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>C pointer aliasing</strong></p>
<p>æ ‡å‡†Cä¸­ï¼ŒæŒ‡é’ˆå¯èƒ½æŒ‡å‘ç›¸åŒæˆ–é‡å çš„æ•°æ®ï¼Œè¿™ç»™ä¼˜åŒ–å¸¦æ¥äº†å›°éš¾ã€‚C99å’ŒC++å¼•å…¥äº†restrictå…³é”®å­—ï¼Œç”¨äºå£°æ˜æŒ‡é’ˆçš„å”¯ä¸€æ€§ï¼Œä»è€Œæé«˜ç¼–è¯‘å™¨çš„ä¼˜åŒ–èƒ½åŠ›ã€‚ARMç¼–è¯‘å™¨å’ŒGCCéƒ½æ”¯æŒrestrictå…³é”®å­—ï¼Œä½†æœ‰ä¸åŒçš„è¯­æ³•å’Œé€‰é¡¹ã€‚</p>
<p><strong>Natural types</strong></p>
<p>ç®—æ³•ä½¿ç”¨ç‰¹å®šæ•°æ®ç±»å‹æœ‰å…¶åŸå› ï¼Œä½†è½¬æ¢ä¸ºå¤„ç†å™¨è‡ªç„¶ç±»å‹å¯ä»¥æé«˜è¿ç®—é€Ÿåº¦å’Œç²¾åº¦ã€‚</p>
<p><strong>Array grouping</strong></p>
<p>å¯¹äºå¯„å­˜å™¨æ•°é‡è¾ƒå°‘çš„å¤„ç†å™¨è®¾è®¡ï¼ˆå¦‚x86ï¼‰ï¼Œé€šå¸¸ä¼šå°†å¤šä¸ªæ•°ç»„åˆå¹¶ä¸ºä¸€ä¸ªã€‚è¿™æ ·å¯ä»¥è®©åŒä¸€ä¸ªæŒ‡é’ˆçš„ä¸åŒåç§»é‡è®¿é—®æ•°æ®çš„ä¸åŒéƒ¨åˆ†ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼å¯èƒ½ä¼šè®©ç¼–è¯‘å™¨è¯¯è®¤ä¸ºåç§»é‡å¯¼è‡´äº†æ•°æ®é›†çš„é‡å ã€‚é™¤éå¯ä»¥ä¿è¯ä¸ä¼šå¯¹æ•°ç»„è¿›è¡Œå†™å…¥æ“ä½œï¼Œå¦åˆ™è¯·é¿å…è¿™æ ·åšã€‚å°†å¤åˆæ•°ç»„æ‹†åˆ†ä¸ºå•ç‹¬çš„æ•°ç»„ï¼Œå¯ä»¥ç®€åŒ–æŒ‡é’ˆçš„ä½¿ç”¨å¹¶æ¶ˆé™¤è¿™ç§é£é™©ã€‚</p>
<p><strong>Inside knowledge</strong></p>
<p>NEONä»£ç éœ€è¦çŸ¥é“æ•°ç»„å¤§å°ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šç”Ÿæˆå¤šä½™çš„ä»£ç ã€‚æ•°ç»„å¤§å°å¯ä»¥åœ¨ç¼–è¯‘æ—¶æŒ‡å®šï¼Œä¹Ÿå¯ä»¥æ ¹æ®å·¥ç¨‹å¸ˆçš„çŸ¥è¯†è¿›è¡Œä¼˜åŒ–ã€‚</p>
<h2 id="Chapter-3-coding-for-NEON"><a href="#Chapter-3-coding-for-NEON" class="headerlink" title="Chapter 3 coding for NEON"></a>Chapter 3 coding for NEON</h2><h3 id="3-1-Overview"><a href="#3-1-Overview" class="headerlink" title="3.1 Overview"></a>3.1 Overview</h3><p>è¿™ä»½guideåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>Memory operations, and how to use the flexible load and store instructions. </li>
<li>Using the permutation instructions to deal with load and store leftovers. </li>
<li>Using NEON to perform an example data processing task, matrix multiplication. </li>
<li>Shifting operations, using the example of converting image data formats.</li>
</ul>
<h3 id="3-2-Load-and-store-example-RGB-conversion"><a href="#3-2-Load-and-store-example-RGB-conversion" class="headerlink" title="3.2 Load and store - example RGB conversion"></a>3.2 Load and store - example RGB conversion</h3><p>æœ¬èŠ‚ä»¥RGBåˆ°BGRçš„è½¬æ¢ä¸ºä¾‹ã€‚åœ¨ä¸€ä¸ª24bitçš„RGBå›¾ä¸­ï¼Œåƒç´ åœ¨å†…å­˜ä¸­ä»¥R G B R G Bçš„æ¨¡å¼å­˜å‚¨ã€‚å‡è®¾ç°åœ¨è¦å®Œæˆä¸€ä¸ªç®€å•çš„å›¾åƒå¤„ç†ï¼Œäº¤æ¢Rå’ŒB channelã€‚å°†RGBæ•°æ®é¡¹æŒ‰é¡ºåºä»å†…å­˜æ”¾å…¥å¯„å­˜å™¨ä¼šä½¿äº¤æ¢çº¢è‰²å’Œè“è‰²é€šé“éš¾ä»¥æ“ä½œã€‚</p>
<p>ä»¥ä¸‹æŒ‡ä»¤å°†RGB dataæ¯æ¬¡ä¸€å­—èŠ‚å­˜å…¥NEONå¯„å­˜å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD1 &#123; V0.16B, V1.16B, V2.16B &#125;, [x0]</span><br></pre></td></tr></table></figure>
<p><img src="/2024/01/02/Neon/image-20240104151616427.png" alt="image-20240104151616427" style="zoom: 50%;"></p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œäº¤æ¢ä¸åŒçš„Laneä¼šæ¯”è¾ƒå¤æ‚ã€‚NEONæä¾›äº†ç»“æ„loadå’ŒstoreæŒ‡ä»¤æ¥åº”å¯¹è¿™ç§æƒ…å†µï¼Œå¯ä»¥å°†è¿ç»­çš„æ•°æ®åˆ†åˆ«å­˜å‚¨åˆ°ä¸åŒçš„å¯„å­˜å™¨ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯ä»¥ä½¿ç”¨LD3æŒ‡ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD3 &#123; V0.16B, V1.16B, V2.16B &#125;, [x0]</span><br></pre></td></tr></table></figure>
<p><img src="/2024/01/02/Neon/image-20240104151905763.png" alt="image-20240104151905763" style="zoom:50%;"></p>
<p>è¿™æ ·åªéœ€è¦ä½¿ç”¨MOVæŒ‡ä»¤å¯¹æ•´ä¸ªVectoräº¤æ¢ï¼Œç„¶åä½¿ç”¨ST3 storeæŒ‡ä»¤å†™å›ï¼Œå®Œæ•´çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LD3 &#123; V0.16B, V1.16B, V2.16B &#125;, [x0], #48 // 3-way interleaved load from</span><br><span class="line"> // address in X0, post-incremented</span><br><span class="line"> // by 48</span><br><span class="line">MOV V3.16B, V0.16B // Swap V0 -&gt; V3</span><br><span class="line">MOV V0.16B, V2.16B // Swap V2 -&gt; V0</span><br><span class="line">MOV V2.16B, V3.16B // Swap V3 -&gt; V2</span><br><span class="line"> // (net effect is to swap V0 and V2)</span><br><span class="line">ST3 &#123; V0.16B, V1.16B, V2.16B &#125;, [x1], #48 // 3-way interleaved store to address</span><br><span class="line"> // in X1, post-incremented by 48</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ¯ä¸€æ­¥çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<ul>
<li>Loads from memory 16 red bytes into V0, 16 green bytes into V1, and 16 blue bytes into V2. </li>
<li>Increments the source pointer in X0 by 48 bytes ready for the next iteration. The increment of 48 bytes is the total number of bytes that we read into all three registers, so 3 x 16 bytes in total. </li>
<li>Swaps the vector of red values in V0 with the vector of blue values in V2, using V3 as an intermediary. </li>
<li>Stores the data in V0, V1, and V2 to memory, starting at the address that is specified by the destination pointer in X1, and increments the pointer.</li>
</ul>
<h3 id="3-3-Load-and-store-data-structures"><a href="#3-3-Load-and-store-data-structures" class="headerlink" title="3.3 Load and store - data structures"></a>3.3 Load and store - data structures</h3><p>åœ¨ä¸Šä¸€ä¸ªä¾‹å­ä¸­æåˆ°çš„æŒ‡ä»¤è¿›è¡Œçš„æ“ä½œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240104152831778.png" alt="image-20240104152831778" style="zoom:50%;"></p>
<p>æŒ‡ä»¤çš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240104152856011.png" alt="image-20240104152856011" style="zoom:50%;"></p>
<p>å…¶ä¸­çš„Registersæ ¹æ®interleave patternæœ€å¤šå¯ä»¥æœ‰å››ä¸ªï¼Œåé¢çš„16Bè¡¨ç¤ºæ¯ä¸ªæ•°æ®æ˜¯1B(byte)ï¼Œæ¯ä¸ªå‘é‡æ˜¯128bitï¼Œå­˜å‚¨16Bã€‚æ•°æ®ç±»å‹æœ‰8(B)ï¼Œ16(H)ï¼Œ32(S)ï¼Œ64(D)bitsã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LD2 &#123;V0.8H, V1.8H&#125;, [X0]</span><br><span class="line">LD2 &#123;V0.4S, V1.4S&#125;, [X0]</span><br></pre></td></tr></table></figure>
<p><img src="/2024/01/02/Neon/image-20240104153412464.png" alt="image-20240104153412464" style="zoom: 33%;"></p>
<p><img src="/2024/01/02/Neon/image-20240104153437456.png" alt="image-20240104153437456" style="zoom:33%;"></p>
<p>structure loadè¿˜å…è®¸åŠ è½½ä¸€ä¸ªå…ƒç´ åˆ°vectorçš„æ‰€æœ‰laneä¸­ï¼Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD3R &#123; V0.16B, V1.16B, V2.16B &#125; , [x0]</span><br></pre></td></tr></table></figure>
<p><img src="/2024/01/02/Neon/image-20240104153841418.png" alt="image-20240104153841418" style="zoom: 50%;"></p>
<p>ä¹Ÿå¯ä»¥åªloadåˆ°ä¸€ä¸ªlaneå½“ä¸­ï¼Œè¿™åœ¨ä»å­˜å‚¨ä¸­è·å–åˆ†æ•£çš„æ•°æ®åˆ°vectorä¸­å¾ˆæœ‰ç”¨ï¼š<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD3 &#123; V0.B, V1.B, V2.B &#125;[4] , [x0]</span><br></pre></td></tr></table></figure></p>
<p><img src="/2024/01/02/Neon/image-20240104154024393.png" alt="image-20240104154024393" style="zoom:50%;"></p>
<p>[]å¯ä»¥æŒ‡å®šåœ°å€åç§»ã€‚ä¸ºäº†æ–¹ä¾¿ä¸‹ä¸€æ¬¡è¯»å†™ï¼ŒæŒ‡ä»¤åå¯ä»¥æ·»åŠ #immï¼Œä¼šç›´æ¥ç»™x0åœ°å€çš„å€¼+immã€‚</p>
<p>é™¤äº†ä¸Šè¿°çš„structure load and storeï¼ŒNEONä¹Ÿæä¾›å…¶ä»–ç±»å‹çš„LDå’ŒSTæŒ‡ä»¤ï¼Œè¯¦è§Arm Architecture Reference Manualã€‚</p>
<h3 id="3-4-Load-and-store-leftovers"><a href="#3-4-Load-and-store-leftovers" class="headerlink" title="3.4 Load and store - leftovers"></a>3.4 Load and store - leftovers</h3><p>æœ‰æ—¶è¾“å…¥æ•°æ®ä¸æ˜¯å‘é‡å¯„å­˜å™¨lanesçš„æ•´æ•°å€ã€‚ä¾‹å¦‚ä¸€ä¸ªè¾“å…¥æ•°ç»„æœ‰21ä¸ª16bitçš„å…ƒç´ ã€‚NEONå¯„å­˜å™¨å¯ä»¥ä¸€æ¬¡å¤„ç†8ä¸ªå…ƒç´ ï¼Œæœ€åä¸€æ¬¡è¿­ä»£åªæœ‰5ä¸ªå…ƒç´ ï¼Œè¿™5ä¸ªå…ƒç´ æ— æ³•å¡«æ»¡å¯„å­˜å™¨ã€‚</p>
<p>æœ‰ä¸‰ç§å¤„ç†è¿™ç§æƒ…å†µçš„åŠæ³•ï¼Œéœ€è¦æ ¹æ®æƒ…å†µé€‰æ‹©ï¼š</p>
<ul>
<li>Extend arrays with padding</li>
<li>Overlap data elements</li>
<li>Process leftovers as single elements</li>
</ul>
<p><strong>Extend arrays with padding</strong></p>
<p>å¦‚æœæ•°ç»„é•¿åº¦å¯å˜ï¼Œå¯ä»¥å°†å…¶å¡«å……åˆ°vector sizeçš„å€æ•°ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸å½±å“å…¶ä»–æ•°æ®çš„æƒ…å†µä¸‹è¿›è¡Œæ•°æ®è¯»å†™ã€‚paddingå€¼åº”è¯¥ä¸å½±å“è®¡ç®—çš„ç»“æœã€‚</p>
<p><img src="/2024/01/02/Neon/image-20240104161852536.png" alt="image-20240104161852536" style="zoom:50%;"></p>
<p><strong>Overlap data elements</strong></p>
<p>å¦‚æœæ“ä½œåˆé€‚ï¼Œå¯ä»¥é€šè¿‡é‡å å…ƒç´ å¤„ç†å¤šå‡ºæ¥çš„å…ƒç´ ã€‚</p>
<p><img src="/2024/01/02/Neon/image-20240104162820857.png" alt="image-20240104162820857" style="zoom:50%;"></p>
<p><strong>Process leftovers as single elements</strong></p>
<p>NEONæä¾›äº†å¯å¯¹å‘é‡ä¸­çš„å•ä¸ªå…ƒç´ æ“ä½œçš„æŒ‡ä»¤ï¼Œæœ€åçš„å…ƒç´ å¯ä»¥å•ç‹¬è¿›è¡Œå¤„ç†ã€‚è¿™ç§æ–¹å¼æ¯”å‰ä¸¤ç§éƒ½æ…¢ï¼Œå¹¶ä¸”ä¼šå¢åŠ ä»£ç è§„æ¨¡ã€‚ </p>
<p>è¿˜æœ‰ä¸€äº›å…¶ä»–éœ€è¦å…³æ³¨çš„ç‚¹ï¼š</p>
<ul>
<li>åœ°å€å¯¹é½ï¼šload and storeæŒ‡ä»¤çš„åœ°å€åº”è¯¥å’Œç¼“å­˜è¡Œçš„å¤§å°å¯¹é½ï¼Œä»¥å®ç°æ›´é«˜æ•ˆçš„è®¿å­˜ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨A64çš„æŒ‡ä»¤å®Œæˆå•ç‹¬å…ƒç´ çš„çš„è®¡ç®—ï¼Œä½†æ˜¯è¦NEONå’ŒA64æŒ‡ä»¤å†™å…¥ç›¸åŒçš„å†…å­˜ï¼Œç‰¹åˆ«æ˜¯ç›¸åŒçš„cache lineã€‚</li>
</ul>
<h3 id="3-5-Permutation-rearranging-vectors"><a href="#3-5-Permutation-rearranging-vectors" class="headerlink" title="3.5 Permutation - rearranging vectors"></a>3.5 Permutation - rearranging vectors</h3><p>åœ¨ç¼–å†™SIMDç¨‹åºæ—¶ï¼Œæ•°æ®çš„é¡ºåºå¾ˆé‡è¦ï¼Œä¸æ€§èƒ½ç›´æ¥ç›¸å…³ï¼Œæœ‰æ—¶æ•°æ®åœ¨å†…å­˜ä¸­çš„ä½ç½®å¯èƒ½ä¸åˆé€‚æˆ–ä¸æ˜¯æœ€ä¼˜çš„ã€‚</p>
<p>ä¸€ä¸ªè§£å†³ä¸Šè¿°é—®é¢˜çš„æ–¹æ³•æ˜¯é‡æ–°å®‰æ’æ•°æ®ã€‚è¿™ç§æ–¹å¼çš„æ€§èƒ½å¼€é”€å¾ˆé«˜ã€‚æ›´å¥½çš„åŠæ³•æ˜¯åœ¨æ•°æ®è¢«å¤„ç†æ—¶é‡æ–°å®‰æ’æ•°æ®ï¼Œé‡å®‰æ’è¢«ç§°ä¸ºpermutationï¼ŒNEONæä¾›äº†ä¸€ç³»åˆ—permuteæŒ‡ä»¤ï¼Œå®ç°ä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>Take input data from one or more source registers</li>
<li>Rearrange the data</li>
<li>Write the result of the permutation to a destination register</li>
</ul>
<p><strong>Permutation guidelines</strong></p>
<ul>
<li>permuting dataä¸æ˜¯ä»€ä¹ˆæ—¶å€™éƒ½æœ‰ç”¨ã€‚</li>
<li>permuteæŒ‡ä»¤ä¼šå¸¦æ¥å¼€é”€ã€‚</li>
<li>ä¸åŒçš„æŒ‡ä»¤ä½¿ç”¨ä¸åŒçš„piplineã€‚æœ€ä¼˜çš„æ–¹æ³•æ˜¯æœ€å¤§åŒ–piplineçš„ä½¿ç”¨ã€‚å› æ­¤éœ€è¦å°½é‡å°‘ä½¿ç”¨permuteæ“ä½œï¼Œé€‰æ‹©æ‰§è¡Œæ—¶ä¼šåˆ©ç”¨ç©ºé—²piplineçš„æŒ‡ä»¤ã€‚</li>
</ul>
<h3 id="3-6-Permutation-NEON-instructions"><a href="#3-6-Permutation-NEON-instructions" class="headerlink" title="3.6 Permutation - NEON instructions"></a>3.6 Permutation - NEON instructions</h3><p>è¿™ä¸€èŠ‚ä»‹ç»çš„permuteæŒ‡ä»¤åŒ…æ‹¬ï¼š</p>
<ul>
<li>Move</li>
<li>Reverse</li>
<li>Extraction</li>
<li>Transpose</li>
<li>Interleave</li>
<li>Lookup table</li>
</ul>
<p>è¿™é‡Œä¸ä¸€ä¸€è¯´æ˜è¿™äº›æŒ‡ä»¤äº†ï¼Œéœ€è¦æ—¶å†æŸ¥è¯¢ã€‚</p>
<h3 id="3-7-Matrix-multiplication"><a href="#3-7-Matrix-multiplication" class="headerlink" title="3.7 Matrix multiplication"></a>3.7 Matrix multiplication</h3><p>è¿™ä¸€èŠ‚æ˜¯NEONå®ç°çŸ©é˜µä¹˜æ³•çš„ä¾‹å­ã€‚å‡å®šçŸ©é˜µæŒ‰ç…§åˆ—é¡ºåºå­˜å‚¨(OpenGL ESçš„å­˜å‚¨æ ¼å¼)ã€‚æ¯æ¬¡è®¡ç®—4*4çš„çŸ©é˜µã€‚</p>
<p><img src="/2024/01/02/Neon/image-20240104165307145.png" alt="image-20240104165307145"></p>
<p>ä¸‹å›¾æ˜¾ç¤ºäº†ä½¿ç”¨NEONçš„FMULæŒ‡ä»¤å®ç°å‘é‡å’Œæ ‡é‡çš„ç›¸ä¹˜ï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240104165519702.png" alt="image-20240104165519702" style="zoom: 80%;"></p>
<p>å¯¹åº”çŸ©é˜µçš„è®¡ç®—ä¸ºï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240104165611277.png" alt="image-20240104165611277"></p>
<p>NEONå¯„å­˜å™¨å¯ä»¥æŒ‰ç…§ä¸åŒçš„æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240104165731965.png" alt="image-20240104165731965" style="zoom: 50%;"></p>
<p>çŸ©é˜µä¹˜æ³•åˆ†ä¸‰æ­¥å®Œæˆï¼š</p>
<ul>
<li>LoadçŸ©é˜µæ•°æ®</li>
<li>çŸ©é˜µä¹˜æ³•</li>
<li>å­˜å‚¨ç»“æœ</li>
</ul>
<p>loadæ•°æ®çš„æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LD1 &#123;V0.4S, V1.4S, V2.4S, V3.4S&#125;, [X1]</span><br><span class="line">LD1 &#123;V4.4S, V5.4S, V6.4S, V7.4S&#125;, [X2]</span><br></pre></td></tr></table></figure>
<p>NEONæä¾›32ä¸ª128bitå®½çš„å¯„å­˜å™¨ã€‚åœ¨è¿™ä¸ªå®ç°ä¸­ï¼ŒV0-V3å­˜å‚¨äº†ç¬¬ä¸€ä¸ªçŸ©é˜µçš„16ä¸ªå…ƒç´ ï¼ŒV4-V7å­˜å‚¨äº†ç¬¬äºŒä¸ªçŸ©é˜µçš„16ä¸ªå…ƒç´ ã€‚æ¯ä¸ªå¯„å­˜å™¨å­˜å‚¨ä¸€ä¸ªçŸ©é˜µè¡Œã€‚</p>
<p>ä»¥ä¸‹ä»£ç è®¡ç®—ä¸€åˆ—çš„ç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FMUL V8.4S, V0.4S, V4.S[0] // rslt col0 = (mat0 col0) * (mat1 col0 elt0)</span><br><span class="line">FMLA V8.4S, V1.4S, V4.S[1] // rslt col0 += (mat0 col1) * (mat1 col0 elt1)</span><br><span class="line">FMLA V8.4S, V2.4S, V4.S[2] // rslt col0 += (mat0 col2) * (mat1 col0 elt2)</span><br><span class="line">FMLA V8.4S, V3.4S, V4.S[3] // rslt col0 += (mat0 col3) * (mat1 col0 elt3)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„çŸ©é˜µè¿ç®—ä»£ç å°±ç•¥å»äº†ã€‚åªè¦æŒ‰ç…§ä»¥ä¸Šä»£ç è®¡ç®—æ¯ä¸€åˆ—å°±å¯ä»¥äº†ã€‚æ¯ä¸€åˆ—è¦å››æ¡æŒ‡ä»¤ï¼Œå°†å…¶è¿›è¡Œäº¤é”™ï¼Œå¯ä»¥æé«˜æµæ°´çº¿çš„ILPã€‚</p>
<h3 id="3-8-Shifting-left-and-right"><a href="#3-8-Shifting-left-and-right" class="headerlink" title="3.8 Shifting left and right"></a>3.8 Shifting left and right</h3><p>æœ¬èŠ‚ä»‹ç»äº†NEONæä¾›çš„shiftæ“ä½œã€‚</p>
<p>NEONçš„å‘é‡shiftå’Œæ ‡é‡çš„æ“ä½œå¾ˆç±»ä¼¼ï¼Œå°†å…ƒç´ ä¸­çš„ä½å·¦ç§»æˆ–å³ç§»ï¼Œç§»å‡ºçš„ä½ä¼šè¢«èˆå¼ƒï¼Œä¸ä¼šç§»åˆ°ç›¸é‚»çš„ä½ç½®ã€‚ç§»ä½æ•°å¯ä»¥æ˜¯æŒ‡ä»¤æŒ‡å®šçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç§»ä½å‘é‡ã€‚</p>
<p>ä¸‹å›¾æ˜¯NEONçš„SSHLæŒ‡ä»¤ï¼ŒV1æ˜¯ç§»ä½å‘é‡ï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240104173138848.png" alt="image-20240104173138848"></p>
<p>åœ¨å³ç§»ä½æ“ä½œæ—¶ï¼Œè¦è€ƒè™‘å¤„ç†çš„æ˜¯æœ‰ç¬¦å·è¿˜æ˜¯æ— ç¬¦å·çš„æ•°æ®ã€‚SSHLæ˜¯æœ‰ç¬¦å·çš„shiftæ“ä½œã€‚ç›¸åº”çš„USHLæ˜¯æ— ç¬¦å·çš„ã€‚</p>
<p>NEONè¿˜æ”¯æŒæ’å…¥shiftï¼Œå¦‚ä¸‹å›¾çš„SLIæŒ‡ä»¤ï¼š</p>
<p><img src="/2024/01/02/Neon/image-20240104173449521.png" alt="image-20240104173449521"></p>
<p>æ­¤åæ˜¯shiftæŒ‡ä»¤çš„ä¸€äº›å…¶ä»–å¯é€‰é¡¹çš„ä»‹ç»ï¼Œä»¥åŠä¸€ä¸ªä¾‹å­ï¼Œè¿™é‡Œéƒ½ç•¥å»äº†ã€‚</p>
<h2 id="Chapter-4-NEON-Intrinsics"><a href="#Chapter-4-NEON-Intrinsics" class="headerlink" title="Chapter 4 NEON Intrinsics"></a>Chapter 4 NEON Intrinsics</h2><h3 id="4-1-Overview"><a href="#4-1-Overview" class="headerlink" title="4.1 Overview"></a>4.1 Overview</h3><p>NEON Intrinsicsæä¾›äº†ç®€å•çš„NEONæŒ‡ä»¤ç¼–å†™æ–¹å¼ã€‚æœ‰ç¬¦åˆNEONçš„æ•°æ®ç±»å‹(Då’ŒQå¯„å­˜å™¨çš„å¤§å°éƒ½æœ‰)ï¼Œå¯ä»¥ä½¿ç”¨Cå˜é‡æ¥åˆ†é…NEONå¯„å­˜å™¨ã€‚ç”±ç¼–è¯‘å™¨ç”Ÿæˆå…·ä½“çš„ä»£ç ã€‚ç¼–è¯‘å™¨ä¹Ÿä¼šè¿›è¡Œä¼˜åŒ–ï¼Œè¿›è¡ŒæŒ‡ä»¤é‡æ’åºæ¥å‡å°‘åœé¡¿ï¼Œæé«˜ILPã€‚</p>
<p>NEON intrinsicçš„å®šä¹‰åœ¨<code>arm_neon.h</code>ä¸­ã€‚</p>
<h3 id="4-2-Vector-data-types-for-NEON-intrinsics"><a href="#4-2-Vector-data-types-for-NEON-intrinsics" class="headerlink" title="4.2 Vector data types for NEON intrinsics"></a>4.2 Vector data types for NEON intrinsics</h3><p>æ•°æ®ç±»å‹çš„patternå¦‚ä¸‹ï¼š</p>
<p>type    size    x    numberOfLanes    _t</p>
<p>ä¾‹å¦‚int16x4_tæ˜¯ä¸€ä¸ªæœ‰4ä¸ª16bitçš„short intçš„å‘é‡ã€‚float32x4_tæ˜¯æœ‰4ä¸ª32-bitæµ®ç‚¹çš„å‘é‡ã€‚</p>
<p><img src="/2024/01/02/Neon/image-20240105150025326.png" alt="image-20240105150025326" style="zoom:50%;"></p>
<p>intrinsicsçš„è¾“å…¥å’Œè¾“å‡ºå¯ä»¥æ˜¯è¿™äº›ç±»å‹ã€‚æœ‰äº›intrinsicsä½¿ç”¨å‘é‡å…ƒç´ æ„æˆçš„æ•°ç»„ï¼ŒåŒ…å«2,3,4ä¸ªç›¸åŒçš„å‘é‡å…ƒç´ ï¼Œè¿™æ ·çš„ç±»å‹ä¸ºï¼š</p>
<p>type    size    x    numberOfLanes    x    lengthOfArray    _t</p>
<p>è¿™äº›ç±»å‹æ˜¯Cç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªvalçš„æ•°ç»„ã€‚è¿™æ ·çš„ç±»å‹å¯ä»¥é€šè¿‡NEONçš„æŒ‡ä»¤ä¸€æ¬¡åŠ è½½æˆ–å­˜å‚¨4ä¸ªå‘é‡å¯„å­˜å™¨çš„å€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">int16x4x2_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="type">int16x4_t</span> val[<span class="number">2</span>];</span><br><span class="line">&#125; &lt;var_name&gt;;</span><br></pre></td></tr></table></figure>
<p>è¿™äº›ç±»å‹åªèƒ½ä½¿ç”¨loadï¼Œstoreï¼Œtransposeï¼Œinterleaveï¼ŒdeinterleaveæŒ‡ä»¤ã€‚å¯ä»¥é€šè¿‡ä¸‹æ ‡è®¿é—®å•ä¸ªå¯„å­˜å™¨ï¼Œä¾‹å¦‚var_name.val[0]ã€‚</p>
<p>ğŸ”°initializeï¼švector data typeä¸èƒ½èµ‹å€¼åˆå§‹åŒ–ï¼Œå¯ä»¥ä½¿ç”¨loadæŒ‡ä»¤åˆå§‹åŒ–æˆ–ä½¿ç”¨vcreate intrinsicåˆå§‹åŒ–ã€‚</p>
<h3 id="4-3-Prototype-of-NEON-Intrinsics"><a href="#4-3-Prototype-of-NEON-Intrinsics" class="headerlink" title="4.3 Prototype of NEON Intrinsics"></a>4.3 Prototype of NEON Intrinsics</h3><p>NEON intrinsicsçš„æŒ‡ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p>opname    flags_type</p>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>vmul_s16ï¼Œå°†ä¸¤ä¸ªå«16bit signedçš„å‘é‡ç›¸ä¹˜</li>
<li>vaddl_u8ï¼Œå°†ä¸¤ä¸ªå­˜å‚¨unsigned 8bitå€¼çš„64bitå‘é‡ç›¸åŠ ï¼Œå¾—åˆ°128bitçš„å­˜å‚¨unsigned 16bitå‘é‡</li>
</ul>
<p>flagå¯ä»¥å–qï¼Œè¡¨ç¤ºè®¡ç®—æ“ä½œæ˜¯é’ˆå¯¹128bitå‘é‡çš„ã€‚</p>
<p>ğŸ”°Noteï¼šå«æœ‰__fp16çš„æŒ‡ä»¤åªç”¨äºæ”¯æŒåŠç²¾åº¦æ‰©å±•VFPçš„æ¶æ„ã€‚</p>
<h3 id="4-4-Using-NEON-intrinsics"><a href="#4-4-Using-NEON-intrinsics" class="headerlink" title="4.4 Using NEON intrinsics"></a>4.4 Using NEON intrinsics</h3><p>intrinsicså«qçš„è¡¨ç¤ºåœ¨Qå¯„å­˜å™¨æ“ä½œï¼Œä¸å«qçš„è¡¨ç¤ºåœ¨Då¯„å­˜å™¨æ“ä½œã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint8x8_t vadd_u8(uint8x8_t a, uint8x8_t b); #64bit</span><br><span class="line">uint8x16_t vaddq_u8(uint8x16_t a, uint8x16_t b); #128bit</span><br></pre></td></tr></table></figure>
<p>æœ‰äº›æŒ‡ä»¤æ²¡æœ‰qåç¼€ï¼Œä¹Ÿæ˜¯ä¼šä½¿ç”¨Qå¯„å­˜å™¨çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint16x8_t vaddl_u8(uint8x8_t a, uint8x8_t b);</span><br></pre></td></tr></table></figure>
<p>ä¸€äº›NEON intrinsicsæŒ‡ä»¤ä¼šä½¿ç”¨32bitçš„é€šç”¨å¯„å­˜å™¨ä½œä¸ºè¾“å…¥å­˜å‚¨æ ‡é‡ã€‚ä¾‹å¦‚ä»¥ä¸‹è¿™ä¸€äº›æŒ‡ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vget_lane_u8 #get single value</span><br><span class="line">vset_lane_u8 #set single value </span><br><span class="line">vcreate_u8 #create vector from literal value</span><br><span class="line">vdup_n_u8 #set all lanes to the same literal value</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨intrinsicsæ—¶ï¼Œä½¿ç”¨ä¸åŒçš„ç±»å‹æ“ä½œä¼šæ¯”è¾ƒå›°éš¾ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šè·Ÿè¸ªå¯„å­˜å™¨å­˜å‚¨çš„ç±»å‹ã€‚å¯„å­˜å™¨ä¹Ÿä¼šè°ƒåº¦ç¨‹åºæµåŠè°ƒæ•´ç¨‹åºåŠ å¿«æ‰§è¡Œã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå°†4lane 32bitå‘é‡å…ƒç´ ç¿»å€çš„ä¾‹å­ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arm_neon.h&gt;</span></span></span><br><span class="line"><span class="type">uint32x4_t</span> <span class="title function_">double_elements</span><span class="params">(<span class="type">uint32x4_t</span> input)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>(vaddq_u32(input, input));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-5-Variables-and-constants-in-NEON-code"><a href="#4-5-Variables-and-constants-in-NEON-code" class="headerlink" title="4.5 Variables and constants in NEON code"></a>4.5 Variables and constants in NEON code</h3><p>è¿™ä¸€èŠ‚ä¸»è¦æ˜¯ä¸€äº›example codeï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//declaring variable</span></span><br><span class="line"><span class="type">uint32x2_t</span> vec64a, vec64b;</span><br><span class="line"><span class="comment">//using constants</span></span><br><span class="line">uint8x8 start_value = vdup_n_u8(<span class="number">0</span>);</span><br><span class="line">uint8x8 start_value = vreinterpret_u8_u64(vcreate_u64(<span class="number">0x123456789ABCDEF</span>ULL));</span><br><span class="line"><span class="comment">//moving results back to C variables get_lane0/VST store to memory</span></span><br><span class="line">result = vget_lane_u32(vec64a, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//Accessing D registers from a Q register</span></span><br><span class="line">vec64a = vget_low_u32(vec128); <span class="comment">// split 128-bit vector </span></span><br><span class="line">vec64b = vget_high_u32(vec128); <span class="comment">// into 2x 64-bit vectors</span></span><br><span class="line"><span class="comment">//Casting NEON variables between different types</span></span><br><span class="line"><span class="type">uint8x8_t</span> byteval;</span><br><span class="line"><span class="type">uint32x2_t</span> wordval;</span><br><span class="line">byteval = vreinterpret_u8_u32(wordval);</span><br><span class="line"><span class="type">uint8x16_t</span> byteval2;</span><br><span class="line"><span class="type">uint32x4_t</span> wordval2;</span><br><span class="line">byteval2 = vreinterpretq_u8_u32(wordval2)</span><br></pre></td></tr></table></figure>
<h3 id="4-6-Accessing-vector-types-from-C"><a href="#4-6-Accessing-vector-types-from-C" class="headerlink" title="4.6 Accessing vector types from C"></a>4.6 Accessing vector types from C</h3><p>Cä¸­çš„æ•°æ®æ ¼å¼æ­£å¦‚ä¸Šè¿°ï¼Œå†™ä¸ºuint8x16_tæˆ–è€…int16x4_tè¿™æ ·çš„ç±»å‹ã€‚æ ‡é‡å’Œvectorä¹‹é—´å¿…é¡»é€šè¿‡intrinsicsæŒ‡ä»¤å¤„ç†ï¼Œä¾‹å¦‚result = vget_lane_u32(vec64a, 0)ã€‚</p>
<h3 id="4-7-Loading-data-from-memory-into-vectors"><a href="#4-7-Loading-data-from-memory-into-vectors" class="headerlink" title="4.7 Loading data from memory into vectors"></a>4.7 Loading data from memory into vectors</h3><p>intrinsicsä½¿ç”¨vld1_datatypeåŠ è½½è¿ç»­çš„æ•°æ®ï¼Œä»¥ä¸‹æ˜¯ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arm_neon.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> A[] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;; <span class="comment">// array with 4 elements</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">uint16x4_t</span> v; <span class="comment">// declare a vector of four 16-bit lanes</span></span><br><span class="line">    v = vld1_u16(A); <span class="comment">// load the array from memory into a vector</span></span><br><span class="line">    v = vadd_u16(v,v); <span class="comment">// double each element in the vector</span></span><br><span class="line">    vst1_u16(A, v); <span class="comment">// store the vector back to memory</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-8-Constructing-a-vector-from-a-literal-bit-pattern"><a href="#4-8-Constructing-a-vector-from-a-literal-bit-pattern" class="headerlink" title="4.8 Constructing a vector from a literal bit pattern"></a>4.8 Constructing a vector from a literal bit pattern</h3><p>NEON intrinsicsé€šè¿‡vcreate_datatypeæ¥ä»å¸¸é‡å€¼åˆ›å»ºå‘é‡ï¼Œä»¥ä¸‹æ˜¯ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arm_neon.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">uint8x8_t</span> v; <span class="comment">// define v as a vector with 8 lanes of 8-bit data</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> A[<span class="number">8</span>]; <span class="comment">// allocate memory for eight 8-bit data</span></span><br><span class="line">    v = vcreate_u8(<span class="number">0x0102030405060708</span>); <span class="comment">// create a vector that contains the values</span></span><br><span class="line">    <span class="comment">// 1,2,3,4,5,6,7,8</span></span><br><span class="line">    vst1_u8(A, v); <span class="comment">// store the vector to memory, in this case, to array A</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-9-Constructing-multiple-vectors-from-interleaved-memory"><a href="#4-9-Constructing-multiple-vectors-from-interleaved-memory" class="headerlink" title="4.9  Constructing multiple vectors from interleaved memory"></a>4.9  Constructing multiple vectors from interleaved memory</h3><p>NEONæ”¯æŒäº¤é”™loadæ•°æ®ã€‚äº¤é”™æ¨¡å¼ç”±næŒ‡å®šï¼ŒæŒ‡ä»¤ä¸ºvldn_datatypeï¼Œæ­£å¦‚åœ¨ç¬¬ä¸‰ç« ä»‹ç»çš„é‚£æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arm_neon.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">uint8x8x3_t</span> v; <span class="comment">// This represents 3 vectors. </span></span><br><span class="line">    <span class="comment">// Each vector has eight lanes of 8-bit data.</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> A[<span class="number">24</span>]; <span class="comment">// This array represents a 24-bit RGB image. </span></span><br><span class="line">    v = vld3_u8(A); <span class="comment">// This de-interleaves the 24-bit image from array A </span></span><br><span class="line">    <span class="comment">// and stores them in 3 separate vectors</span></span><br><span class="line">    <span class="comment">// v.val[0] is the first vector in V. It is for the red channel</span></span><br><span class="line">    <span class="comment">// v.val[1] is the second vector in V. It is for the green channel</span></span><br><span class="line">    <span class="comment">// v.val[2] is the third vector in V. It is for the blue channel.</span></span><br><span class="line">    <span class="comment">//Double the red channel</span></span><br><span class="line">    v.val[<span class="number">0</span>] = vadd_u8(v.val[<span class="number">0</span>],v.val[<span class="number">0</span>]);</span><br><span class="line">    vst3_u8(A, v); <span class="comment">// store the vector back into the array, with the red channel doubled.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-10-Programming-using-NEON-intrinsics"><a href="#4-10-Programming-using-NEON-intrinsics" class="headerlink" title="4.10 Programming using NEON intrinsics"></a>4.10 Programming using NEON intrinsics</h3><p>NEONç¼–ç¨‹éœ€è¦è€ƒè™‘åˆ°ç®—æ³•æ€æ ·èƒ½å¤Ÿå®ç°å¹¶è¡Œï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªè®¡ç®—æ•°ç»„å’Œçš„ä¾‹å­ï¼Œå‡è®¾næ˜¯4çš„å€æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arm_neon.h&gt;</span></span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">vector_add_of_n</span><span class="params">(<span class="type">uint32_t</span>* ptr, <span class="type">uint32_t</span> items)</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> result,* i;</span><br><span class="line">    <span class="type">uint32x2_t</span> vec64a, vec64b;</span><br><span class="line">    <span class="type">uint32x4_t</span> vec128 = vdupq_n_u32(<span class="number">0</span>); <span class="comment">// clear accumulators</span></span><br><span class="line">    <span class="keyword">for</span> (i=ptr; i&lt;(ptr+(items/<span class="number">4</span>));i+=<span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="type">uint32x4_t</span> temp128 = vld1q_u32(i); <span class="comment">// load four 32-bit values</span></span><br><span class="line">    vec128=vaddq_u32(vec128, temp128); <span class="comment">// add 128-bit vectors</span></span><br><span class="line">    &#125;</span><br><span class="line">    vec64a = vget_low_u32(vec128); <span class="comment">// split 128-bit vector</span></span><br><span class="line">    vec64b = vget_high_u32(vec128); <span class="comment">// into two 64-bit vectors</span></span><br><span class="line">    vec64a = vadd_u32 (vec64a, vec64b); <span class="comment">// add 64-bit vectors together</span></span><br><span class="line">    result = vget_lane_u32(vec64a, <span class="number">0</span>); <span class="comment">// extract lanes and</span></span><br><span class="line">    result += vget_lane_u32(vec64a, <span class="number">1</span>); <span class="comment">// add together scalars</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://a-y-1.github.io">æ©™</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://a-y-1.github.io/2024/01/02/Neon/">https://a-y-1.github.io/2024/01/02/Neon/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://a-y-1.github.io" target="_blank">æ©™çš„Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/">é«˜æ€§èƒ½è®¡ç®—</a></div><div class="post_share"><div class="social-share" data-image="/../cover/NEON.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/01/06/HPC-Game/" title="HPC-Game"><img class="cover" src="/../cover/HPC-Game0th.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">HPC-Game</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/25/Predicting%20the%20Performance%20of%20Sparse%20Matrix/" title="WISEï¼šPredicting the Performance of Sparse Matrix"><img class="cover" src="/../cover/image-20231223120820448.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">WISEï¼šPredicting the Performance of Sparse Matrix</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2023/09/11/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="é«˜æ€§èƒ½è®¡ç®—å­¦ä¹ è®°å½•"><img class="cover" src="/../cover/hpc.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-11</div><div class="title">é«˜æ€§èƒ½è®¡ç®—å­¦ä¹ è®°å½•</div></div></a></div><div><a href="/2023/10/13/CMU15-418notes(1-9)/" title="CMU15-418notes(1-9)"><img class="cover" src="/../cover/CMU15-418.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-13</div><div class="title">CMU15-418notes(1-9)</div></div></a></div><div><a href="/2023/10/13/Pthread/" title="Pthreadsç®€è®°"><img class="cover" src="/../cover/pthread.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-13</div><div class="title">Pthreadsç®€è®°</div></div></a></div><div><a href="/2023/10/23/CMU15-418notes(10-18)/" title="CMU15-418notes(10-18)"><img class="cover" src="/../cover/CMU15-418.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-23</div><div class="title">CMU15-418notes(10-18)</div></div></a></div><div><a href="/2023/10/27/OpenMP/" title="OpenMP"><img class="cover" src="/../cover/openmp.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-27</div><div class="title">OpenMP</div></div></a></div><div><a href="/2023/10/27/%E8%B6%85%E7%AE%97%E7%AB%9E%E8%B5%9B%E5%AF%BC%E5%BC%95/" title="è¶…ç®—ç«èµ›å¯¼å¼•"><img class="cover" src="/../cover/sc.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-27</div><div class="title">è¶…ç®—ç«èµ›å¯¼å¼•</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/a0.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">æ©™</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/A-Y-1"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-1-Introduction"><span class="toc-text">Chapter 1 Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Data-processing-technologies"><span class="toc-text">1.1 Data processing technologies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Comparison-between-ARM-NEON-technology-and-other-implementations"><span class="toc-text">1.2 Comparison between ARM NEON technology and other implementations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Architecture-support-for-NEON-technology"><span class="toc-text">1.3 Architecture support for NEON technology</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Fundamentals-of-NEON-technology"><span class="toc-text">1.4 Fundamentals of NEON technology</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-2-Compiling-NEON-Instructions"><span class="toc-text">Chapter 2 Compiling NEON Instructions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-3-coding-for-NEON"><span class="toc-text">Chapter 3 coding for NEON</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Overview"><span class="toc-text">3.1 Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Load-and-store-example-RGB-conversion"><span class="toc-text">3.2 Load and store - example RGB conversion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Load-and-store-data-structures"><span class="toc-text">3.3 Load and store - data structures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Load-and-store-leftovers"><span class="toc-text">3.4 Load and store - leftovers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Permutation-rearranging-vectors"><span class="toc-text">3.5 Permutation - rearranging vectors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-Permutation-NEON-instructions"><span class="toc-text">3.6 Permutation - NEON instructions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-Matrix-multiplication"><span class="toc-text">3.7 Matrix multiplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-Shifting-left-and-right"><span class="toc-text">3.8 Shifting left and right</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-4-NEON-Intrinsics"><span class="toc-text">Chapter 4 NEON Intrinsics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Overview"><span class="toc-text">4.1 Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Vector-data-types-for-NEON-intrinsics"><span class="toc-text">4.2 Vector data types for NEON intrinsics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Prototype-of-NEON-Intrinsics"><span class="toc-text">4.3 Prototype of NEON Intrinsics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Using-NEON-intrinsics"><span class="toc-text">4.4 Using NEON intrinsics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-Variables-and-constants-in-NEON-code"><span class="toc-text">4.5 Variables and constants in NEON code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-Accessing-vector-types-from-C"><span class="toc-text">4.6 Accessing vector types from C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-Loading-data-from-memory-into-vectors"><span class="toc-text">4.7 Loading data from memory into vectors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-Constructing-a-vector-from-a-literal-bit-pattern"><span class="toc-text">4.8 Constructing a vector from a literal bit pattern</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9-Constructing-multiple-vectors-from-interleaved-memory"><span class="toc-text">4.9  Constructing multiple vectors from interleaved memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-10-Programming-using-NEON-intrinsics"><span class="toc-text">4.10 Programming using NEON intrinsics</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/06/HPC-Game/" title="HPC-Game">HPC-Game</a><time datetime="2024-01-06T04:54:29.000Z" title="å‘è¡¨äº 2024-01-06 12:54:29">2024-01-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/02/Neon/" title="NEONç¼–ç¨‹">NEONç¼–ç¨‹</a><time datetime="2024-01-02T12:19:29.000Z" title="å‘è¡¨äº 2024-01-02 20:19:29">2024-01-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/25/Predicting%20the%20Performance%20of%20Sparse%20Matrix/" title="WISEï¼šPredicting the Performance of Sparse Matrix">WISEï¼šPredicting the Performance of Sparse Matrix</a><time datetime="2023-12-25T08:12:14.000Z" title="å‘è¡¨äº 2023-12-25 16:12:14">2023-12-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/22/Efficiently%20Running%20SpMV%20on%20Long%20Vector%20Architectures/" title="Efficiently Running SpMV on Long Vector Architectures">Efficiently Running SpMV on Long Vector Architectures</a><time datetime="2023-12-22T07:25:14.000Z" title="å‘è¡¨äº 2023-12-22 15:25:14">2023-12-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/21/CS149-Assignment-4/" title="CS149-Assignment-4(2023FALL)">CS149-Assignment-4(2023FALL)</a><time datetime="2023-12-21T11:54:29.000Z" title="å‘è¡¨äº 2023-12-21 19:54:29">2023-12-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/../cover/0105.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By æ©™</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>